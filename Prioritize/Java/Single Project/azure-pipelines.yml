# replace .war with .jar or .ear if needed
trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: Maven@3
  inputs:
    mavenPomFile: 'pom.xml'
    goals: 'clean install'
    mavenOptions: -DskipTests=true
    publishJUnitResults: false
    javaHomeOption: 'JDKVersion'
    jdkVersionOption: '1.11'
    mavenVersionOption: 'Default'
    mavenAuthenticateFeed: false
    effectivePomSkip: false
    sonarQubeRunAnalysis: false
- task: CmdLine@2
  displayName: 'WhiteSource Unified Agent Scan'
  inputs:
    script: |
      curl -LJO https://github.com/whitesource/unified-agent-distribution/releases/latest/download/wss-unified-agent.jar
      echo UA downloaded successfully
      WARFILE=$(find ./ -type f -wholename "*/target/*.war")
      export WS_ENABLEIMPACTANALYSIS=true
      export WS_REQUIREKNOWNSHA1=false
      export WS_RESOLVEALLDEPENDENCIES=false
      export WS_MAVEN_RESOLVEDEPENDENCIES=true
      export WS_MAVEN_AGGREGATEMODULES=true
      export WS_FILESYSTEMSCAN=false
      java -jar wss-unified-agent.jar -appPath $WARFILE -d ./ -apikey $(APIKEY) -product GH_${{ github.event.repository.name }} -project ${{ github.ref }}_Prioritize